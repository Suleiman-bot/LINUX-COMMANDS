################################################################################
# VM DISK EXPANSION & LVM MANAGEMENT
# Purpose: Extend logical volumes and resize filesystems
# Used for: Increasing storage when VMs run out of space
################################################################################

# ========== CHECK CURRENT DISK USAGE ==========
# Show all block devices and partitions
lsblk

# Show disk space usage
df -h

# Show filesystem usage (detailed)
df -hT

# Show logical volumes
sudo lvs

# Show volume groups
sudo vgs

# Show physical volumes
sudo pvs

# ========== EXTEND LOGICAL VOLUME ==========
# Extend logical volume to use all free space
sudo lvextend -l +100%FREE /dev/ubuntu-vg/ubuntu-lv

# Extend logical volume by specific size (example: 50GB more)
sudo lvextend -L +50G /dev/ubuntu-vg/ubuntu-lv

# Extend logical volume to specific size (example: 200GB total)
sudo lvextend -L 200G /dev/ubuntu-vg/ubuntu-lv

# Verify logical volume was extended
sudo lvs

# ========== RESIZE FILESYSTEM ==========
# Resize ext4 filesystem to fill extended volume
sudo resize2fs /dev/ubuntu-vg/ubuntu-lv

# Resize XFS filesystem to fill extended volume
sudo xfs_growfs /

# For XFS mounted at specific location
sudo xfs_growfs /vmdata

# ========== VERIFY RESIZE ==========
# Check new disk space
df -h

# Show filesystem information
df -hT

# ========== COMPLETE DISK EXTENSION WORKFLOW ==========
# Full example: extend Ubuntu logical volume

# 1. Check current state
lsblk
df -h
sudo lvs

# 2. Extend logical volume
sudo lvextend -l +100%FREE /dev/ubuntu-vg/ubuntu-lv

# 3. Resize filesystem (ext4)
sudo resize2fs /dev/ubuntu-vg/ubuntu-lv

# 4. Verify new size
df -h

# ========== TROUBLESHOOTING FILESYSTEM RESIZE ==========
# If resize2fs reports filesystem is busy:

# 1. Ensure VM/filesystem is mounted
mount | grep ubuntu-lv

# 2. Try resize anyway (usually still works)
sudo resize2fs /dev/ubuntu-vg/ubuntu-lv

# 3. Force resize if needed
sudo resize2fs -f /dev/ubuntu-vg/ubuntu-lv

# If XFS resize fails, ensure mount point is specified:
sudo xfs_growfs /

# ========== SHRINK LOGICAL VOLUME (CAREFUL!) ==========
# WARNING: Only shrink AFTER shrinking filesystem!
# 1. First shrink filesystem from within the VM or on ext4
# 2. Then shrink logical volume

# Shrink logical volume by 50GB
sudo lvreduce -L -50G /dev/ubuntu-vg/ubuntu-lv

# Shrink to specific size
sudo lvreduce -L 100G /dev/ubuntu-vg/ubuntu-lv

# ========== MONITOR DISK SPACE USAGE ==========
# Show disk usage by directory
du -sh /home/*
du -sh /var/lib/libvirt/images/*

# Show top disk consumers
du -sh /* | sort -rh | head -10

# Monitor disk usage in real-time
watch df -h

# ========== SNAPSHOT BACKUP BEFORE RESIZE ==========
# Create LVM snapshot before making changes (safety backup)
sudo lvcreate -L 10G -s -n ubuntu-lv-snapshot /dev/ubuntu-vg/ubuntu-lv

# Mount snapshot to verify data
sudo mkdir /mnt/snapshot
sudo mount /dev/ubuntu-vg/ubuntu-lv-snapshot /mnt/snapshot

# Delete snapshot after verification
sudo lvremove /dev/ubuntu-vg/ubuntu-lv-snapshot
