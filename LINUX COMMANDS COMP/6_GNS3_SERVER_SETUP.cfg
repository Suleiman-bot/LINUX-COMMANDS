################################################################################
# GNS3 SERVER SETUP & CONFIGURATION
# Purpose: Install GNS3, configure systemd service, manage GNS3 server
# Used for: Network emulation lab setup, automated startup configuration
################################################################################

# ========== INSTALL GNS3 ON LINUX ==========
# Update system packages
sudo apt update && sudo apt upgrade -y

# Install essential packages
sudo apt install -y software-properties-common curl git unzip

# Add GNS3 PPA repository
sudo add-apt-repository ppa:gns3/ppa -y

# Update package list after adding PPA
sudo apt update

# Install GNS3 server and GUI
sudo apt install -y gns3-server gns3-gui

# ========== CHECK GNS3 DIRECTORIES ==========
# List GNS3 projects directory
ls -l ~/GNS3/projects

# List QEMU images directory
ls -l ~/GNS3/images/QEMU

# List GNS3 appliances
ls -l ~/.local/share/GNS3/appliances

# Show GNS3 controller configuration
ls -l ~/.config/GNS3/2.2/gns3_controller.conf

# ========== CREATE GNS3 SYSTEMD SERVICE ==========
# Create systemd service file for GNS3
sudo nano /etc/systemd/system/gns3server.service

# Paste this exact content into the file:
# [Unit]
# Description=GNS3 Server
# After=network.target
#
# [Service]
# Type=simple
# User=unix
# ExecStart=/usr/bin/gns3server --local
# Restart=on-failure
# RestartSec=5
# StandardOutput=append:/var/log/gns3server.log
# StandardError=append:/var/log/gns3server.log
#
# [Install]
# WantedBy=multi-user.target

# ========== ENABLE AND START GNS3 SERVICE ==========
# Reload systemd daemon after creating service file
sudo systemctl daemon-reload

# Enable GNS3 service to start at boot
sudo systemctl enable gns3server.service

# Start GNS3 service immediately
sudo systemctl start gns3server.service

# Check GNS3 service status
sudo systemctl status gns3server.service

# ========== MONITOR GNS3 LOGS ==========
# View GNS3 server logs in real-time
tail -f /var/log/gns3server.log

# View GNS3 logs using journalctl (systemd journal)
sudo journalctl -u gns3server.service -f

# View last 50 lines of log
sudo journalctl -u gns3server.service -n 50

# ========== SERVICE CONTROL COMMANDS ==========
# Check current service status
sudo systemctl status gns3server

# Stop GNS3 service
sudo systemctl stop gns3server.service

# Start GNS3 service
sudo systemctl start gns3server.service

# Restart GNS3 service
sudo systemctl restart gns3server.service

# Disable autostart (won't start at boot)
sudo systemctl disable gns3server

# ========== CONFIGURE GNS3 SERVER ==========
# Edit GNS3 server configuration
nano ~/.config/GNS3/2.2/gns3_server.conf

# Configuration options:
# [Server]
# host = 0.0.0.0
# port = 3080
# auth = false
#
# [Qemu]
# enable_kvm = true  (set to true to enable KVM acceleration, false to disable)

# ========== KVM ACCELERATION CONTROL ==========
# Enable KVM (faster virtualization)
# In gns3_server.conf, set: enable_kvm = true

# Disable KVM (use software emulation - slower)
# In gns3_server.conf, set: enable_kvm = false

# ========== VERIFY GNS3 AT REBOOT ==========
# Reboot the system to verify GNS3 starts automatically
sudo reboot

# After login, verify GNS3 service is running
sudo systemctl status gns3server.service

# ========== KILL STUCK GNS3 PROCESSES ==========
# Kill all GNS3 server processes
pkill -f gns3-server

# Force kill if normal kill doesn't work
pkill -9 -f gns3-server
