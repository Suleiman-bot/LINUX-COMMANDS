################################################################################
# NETWORK CONFIGURATION - Bridge, VLAN, DNS, Interfaces
# Purpose: Configure network bridges, VLANs, DNS, and network interfaces
# Used for: VM networking, bridge setup, static IP configuration
################################################################################

# ========== NETPLAN BRIDGE CONFIGURATION ==========
# Edit netplan configuration file for Debian/Ubuntu
sudo nano /etc/netplan/00-installer-config.yaml

# Basic bridge configuration template:
# network:
#   version: 2
#   ethernets:
#     eno1:
#       dhcp4: false
#       dhcp6: false
#   bridges:
#     virbr1:
#       interfaces: [eno1]
#       dhcp4: false
#       dhcp6: false
#       addresses: [192.168.0.67/24]
#       routes:
#         - to: default
#           via: 192.168.0.1
#           metric: 10
#       nameservers:
#         addresses: [8.8.8.8, 4.2.2.2]
#       parameters:
#         stp: false

# Apply netplan configuration
sudo netplan apply

# Check netplan configuration
sudo netplan get

# ========== NETWORK INTERFACE COMMANDS ==========
# Show all IP addresses and interfaces
ip addr show

# Show specific interface details
ip addr show eno1

# Bring interface up
sudo ip link set eno1 up

# Bring interface down
sudo ip link set eno1 down

# Show all network interfaces
ifconfig

# ========== BRIDGE COMMANDS ==========
# Show all bridges
ip link show type bridge

# Show bridge members
ip link show master virbr1

# Create bridge manually (temporary)
sudo ip link add name br0 type bridge

# Add interface to bridge
sudo ip link set eno1 master virbr1

# Remove interface from bridge
sudo ip link set eno1 nomaster

# ========== DNS CONFIGURATION ==========
# Edit DNS settings (Ubuntu 18.04+)
sudo nano /etc/netplan/00-installer-config.yaml

# Add DNS servers to netplan:
#       nameservers:
#         addresses: [8.8.8.8, 8.8.4.4, 1.1.1.1]

# Apply changes
sudo netplan apply

# Test DNS resolution
nslookup google.com
dig google.com

# Show current DNS servers
cat /etc/resolv.conf

# ========== STATIC IP CONFIGURATION ==========
# Configure static IP via netplan

# Edit netplan file:
# ethernets:
#   eno1:
#     dhcp4: false
#     addresses: [192.168.0.67/24]
#     gateway4: 192.168.0.1
#     nameservers:
#       addresses: [8.8.8.8, 8.8.4.4]

sudo netplan apply

# Verify static IP is set
ip addr show eno1

# ========== CONFIGURE VLAN ON INTERFACE ==========
# Create VLAN interface (example: VLAN 3999 on port eno1)
sudo ip link add link eno1 name eno1.3999 type vlan id 3999

# Bring up VLAN interface
sudo ip link set eno1.3999 up

# Assign IP to VLAN interface
sudo ip addr add 10.0.0.1/24 dev eno1.3999

# Make VLAN configuration permanent via netplan:
# vlans:
#   vlan.3999:
#     id: 3999
#     link: eno1
#     addresses: [10.0.0.1/24]

# ========== FIREWALL - UFW ==========
# Enable UFW firewall
sudo ufw enable

# Allow SSH access
sudo ufw allow 22

# Allow HTTP
sudo ufw allow 80

# Allow HTTPS
sudo ufw allow 443

# Check UFW status and rules
sudo ufw status

# Delete a rule
sudo ufw delete allow 80

# ========== TRACEROUTE & NETWORK DIAGNOSTICS ==========
# Install traceroute (AlmaLinux / RHEL / Rocky / CentOS)
dnf install traceroute -y

# Install traceroute (Debian/Ubuntu)
sudo apt install traceroute -y

# Use traceroute to test network path
traceroute 192.168.56.11

# Faster alternative (usually pre-installed)
tracepath 192.168.56.11

# Test connectivity to server
ping 192.168.56.11

# Test connectivity and show details
ping -c 4 192.168.56.11

# ========== NETWORK TESTING COMMANDS ==========
# Show network connections
netstat -an

# Show listening ports
netstat -tuln

# Show routing table
route -n

# Alternative routing command
ip route show

# Show MAC address table
arp -a

# Show all open connections
ss -an

# Show TCP connections
ss -tn

# ========== RESTART NETWORKING ==========
# Restart networking service
sudo systemctl restart networking

# Or use networkctl
sudo systemctl restart systemd-networkd

# Reload network configuration without restart
sudo netplan apply

# ========== TROUBLESHOOT NETWORK ISSUES ==========
# Check if interface is up
ip link show eno1

# Check if DHCP is configured
systemctl status networking

# Test DNS resolution
resolvectl status

# Flush DNS cache (if applicable)
sudo systemctl restart systemd-resolved
