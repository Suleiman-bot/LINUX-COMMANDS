################################################################################
# QEMU IMAGE MANAGEMENT & TROUBLESHOOTING
# Purpose: Convert, check, inspect, and repair QEMU disk images
# Used for: VirtualBox to KVM migration, disk diagnostics, image optimization
################################################################################

# ========== IMAGE INFORMATION & DIAGNOSTICS ==========
# Get detailed information about a QCOW2 image
qemu-img info /var/lib/libvirt/images/zabbix_appliance-7.0.4-disk001.qcow2

# Get info about another image
qemu-img info /var/lib/libvirt/images/kasi-PRTG.qcow2

# Check for filesystem errors in image (VM must be OFF)
sudo qemu-img check /home/kasi/zabbix_appliance-7.0.4-disk001.qcow2

# ========== CONVERT VirtualBox VDI TO QCOW2 ==========
# Create backup directory for VirtualBox VMs
mkdir -p ~/VBoxBackup

# Copy all VirtualBox VMs to backup
cp -r ~/VirtualBox\ VMs ~/VBoxBackup/

# Convert Zabbix Appliance disk from VDI to QCOW2
qemu-img convert -f vdi -O qcow2 /home/unix/VBoxBackup/'VirtualBox VMs'/zabbix_appliance-7.0.4/zabbix_appliance-7.0.4-disk001.vdi /home/unix/VBoxBackup/Converted-Images/zabbix_appliance-7.0.4-disk001.qcow2

# Convert PRTG VM from VDI to QCOW2
qemu-img convert -f vdi -O qcow2 /home/unix/VBoxBackup/'VirtualBox VMs'/kasi-PRTG/kasi-PRTG.vdi /home/unix/VBoxBackup/Converted-Images/kasi-PRTG.qcow2

# Convert ERPNext Server from VDI to QCOW2
qemu-img convert -f vdi -O qcow2 /home/unix/VBoxBackup/'VirtualBox VMs'/'ERPNext Server'/'ERPNext Server.vdi' /home/unix/VBoxBackup/Converted-Images/'ERPNext Server.qcow2'

# Convert KasiIOT VM from VDI to QCOW2
qemu-img convert -f vdi -O qcow2 /home/unix/VBoxBackup/'VirtualBox VMs'/KasiIOT/KasiIOT.vdi /home/unix/VBoxBackup/Converted-Images/KasiIOT.qcow2

# Convert KasiVidMgr VM from VDI to QCOW2
qemu-img convert -f vdi -O qcow2 /home/unix/VBoxBackup/'VirtualBox VMs'/KasiVidMgnr/KasiVidMgnr.vdi /home/unix/VBoxBackup/Converted-Images/KasiVidMgr.qcow2

# Convert Test Server VM from VDI to QCOW2
qemu-img convert -f vdi -O qcow2 /home/unix/VBoxBackup/'VirtualBox VMs'/testServer/testServer.vdi /home/unix/VBoxBackup/Converted-Images/testServer.qcow2

# ========== VERIFY CONVERTED IMAGES ==========
# Check Zabbix converted image
qemu-img info /home/unix/VBoxBackup/Converted-Images/zabbix_appliance-7.0.4-disk001.qcow2

# Check PRTG converted image
qemu-img info /home/unix/VBoxBackup/Converted-Images/kasi-PRTG.qcow2

# Check KasiIOT converted image
qemu-img info /home/unix/VBoxBackup/Converted-Images/KasiIOT.qcow2

# Check KasiVidMgr converted image
qemu-img info /home/unix/VBoxBackup/Converted-Images/KasiVidMgr.qcow2

# Check Test Server converted image
qemu-img info /home/unix/VBoxBackup/Converted-Images/testServer.qcow2

# ========== REBUILD IMAGE BACKING FILE INFO ==========
# Rebase image to fix broken backing file references (removes dependency)
qemu-img rebase -u /home/kasi/GNS3/images/QEMU/fortios.qcow2

# Rebase vEOS image
qemu-img rebase -u /home/kasi/GNS3/images/QEMU/vEOS-lab-4.33.5M.qcow2

# ========== DISK RECOVERY & BACKUP ==========
# Use ddrescue to safely copy potentially corrupted disk image
sudo ddrescue -n /var/lib/libvirt/images/kasi-otobo.qcow2 /home/kasi/kasi-otobo-rescued.qcow2 rescue.log

# Recovery with 4MB block size (slower but more reliable)
sudo ddrescue -n -b 4M /var/lib/libvirt/images/kasi-otobo.qcow2 /home/kasi/kasi-otobo-rescued.qcow2 rescue.log

# ========== DISK FILE LOCKING CHECK ==========
# Show which processes have a disk image open (useful for troubleshooting)
lsof /home/kasi/GNS3/images/QEMU/vEOS-lab-4.33.5M.qcow2

# Check if Fortios image is in use
lsof /home/kasi/GNS3/images/QEMU/fortios.qcow2

# ========== IMAGE OPTIMIZATION ==========
# Shrink QCOW2 image to reclaim unused space (requires VM to be off)
qemu-img convert -O qcow2 /path/to/old/image.qcow2 /path/to/new/image-optimized.qcow2

# Create snapshot of image for backup
qemu-img snapshot -c backup-$(date +%Y%m%d) /path/to/image.qcow2
