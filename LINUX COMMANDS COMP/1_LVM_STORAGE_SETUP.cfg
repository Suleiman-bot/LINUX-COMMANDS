################################################################################
# LVM (Logical Volume Manager) Storage Setup & Configuration
# Purpose: Create physical volumes, volume groups, logical volumes, and mount storage
# Used for: NVMe drive preparation, VM storage pools, persistent mounting
################################################################################

# ========== STEP 1: CREATE PHYSICAL VOLUME ==========
# Creates a physical volume on raw disk device
sudo pvcreate /dev/nvme0n1

# ========== STEP 2: CREATE VOLUME GROUP ==========
# Creates a volume group named "vm-vg" from the physical volume
sudo vgcreate vm-vg /dev/nvme0n1

# ========== STEP 3: CREATE LOGICAL VOLUME ==========
# Creates logical volume "vmdata" using 100% of available space in the volume group
sudo lvcreate -l 100%FREE -n vmdata vm-vg

# ========== STEP 4: FORMAT LOGICAL VOLUME WITH XFS FILESYSTEM ==========
# Formats the logical volume with XFS filesystem for better performance
sudo mkfs.xfs /dev/vm-vg/vmdata

# ========== STEP 5: CREATE MOUNT POINT ==========
# Creates directory where the volume will be mounted
sudo mkdir /vmdata

# ========== STEP 6: MOUNT LOGICAL VOLUME ==========
# Mounts the logical volume to the /vmdata directory
sudo mount /dev/vm-vg/vmdata /vmdata

# ========== STEP 7: GET UUID FOR PERMANENT MOUNT ==========
# Retrieves the UUID needed for fstab entry
sudo blkid /dev/vm-vg/vmdata

# ========== STEP 8: EDIT FSTAB FOR PERMANENT MOUNT ==========
# Edit /etc/fstab and add this line (replace UUID with actual UUID):
# UUID=<UUID_from_blkid> /vmdata xfs defaults,noatime 0 0
sudo nano /etc/fstab

# ========== STEP 9: CREATE LIBVIRT IMAGE DIRECTORY ==========
# Creates directory specifically for VM images within mounted storage
sudo mkdir -p /vmdata/libvirt-images

# ========== STEP 10: SET OWNERSHIP FOR LIBVIRT ==========
# Sets ownership to root:libvirt so libvirt can manage the directory
sudo chown -R root:libvirt /vmdata/libvirt-images

# ========== STEP 11: SET PERMISSIONS FOR GROUP ACCESS ==========
# Sets 2770 permissions: group members can read/write/execute, setgid for inheritance
sudo chmod 2770 /vmdata/libvirt-images

# ========== STEP 12: DEFINE LIBVIRT STORAGE POOL ==========
# Defines a new libvirt storage pool named "vmdata" pointing to the directory
sudo virsh pool-define-as vmdata dir - - - - /vmdata/libvirt-images

# ========== STEP 13: START STORAGE POOL ==========
# Starts the storage pool immediately
sudo virsh pool-start vmdata

# ========== STEP 14: AUTOSTART STORAGE POOL AT BOOT ==========
# Ensures the storage pool starts automatically on system reboot
sudo virsh pool-autostart vmdata

# ========== STEP 15: ADD USER TO LIBVIRT GROUP ==========
# Allows user to create/manage disks without sudo (replace 'kasi' with your username)
sudo usermod -aG libvirt kasi

# ========== STEP 16: APPLY GROUP CHANGES ==========
# Log out and log back in, or use newgrp to apply group changes immediately
newgrp libvirt

# ========== STEP 17: VERIFY GROUP MEMBERSHIP ==========
# Verify that your user is now in the libvirt group
groups

# ========== STEP 18: CREATE VIRTUAL DISK IN POOL ==========
# Creates a new 50GB QCOW2 disk in the vmdata pool
virsh vol-create-as vmdata myvm.qcow2 50G --format qcow2

# ========== STEP 19: CHECK POOL USAGE ==========
# Displays total and available space in the storage pool
virsh pool-info vmdata

# ========== STEP 20: CHECK INDIVIDUAL DISK USAGE ==========
# Shows size and path of a specific disk image
virsh vol-info --pool vmdata myvm.qcow2

# ========== STEP 21: CHECK FILESYSTEM SPACE ==========
# Shows actual disk usage on the filesystem
du -sh /vmdata/libvirt-images

# ========== STEP 22: LIST ALL VOLUMES IN POOL ==========
# Shows all disk images in the vmdata pool
virsh vol-list vmdata

# ========== STEP 23: CHECK POOL STATUS ==========
# Shows if pool is active and basic information
sudo virsh pool-list --all
