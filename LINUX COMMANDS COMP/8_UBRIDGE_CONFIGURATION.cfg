################################################################################
# UBRIDGE - GNS3 Network Backend Configuration
# Purpose: Configure ubridge for networking in GNS3, fix permissions
# Used for: Network packet bridging, node interconnection in GNS3
################################################################################

# ========== LOCATE UBRIDGE INSTALLATION ==========
# Find where ubridge is installed
which ubridge

# Check current permissions of ubridge
ls -l /usr/bin/ubridge

# ========== FIX UBRIDGE PERMISSIONS ==========
# Make ubridge executable by all users (755 permissions)
sudo chmod 755 /usr/bin/ubridge

# Verify permissions were changed
ls -l /usr/bin/ubridge

# ========== ADD USER TO UBRIDGE GROUP ==========
# Add current user to ubridge group (replace $USER with your username if needed)
sudo usermod -aG ubridge $USER

# Add specific user to ubridge group
sudo usermod -aG ubridge kasi

# ========== APPLY GROUP CHANGES ==========
# IMPORTANT: Log out and log back in for group changes to take effect
# OR use newgrp to apply changes immediately without logging out
newgrp ubridge

# ========== VERIFY UBRIDGE WORKS ==========
# Test if ubridge runs without permission errors
ubridge -v

# Show ubridge version and help
ubridge --help

# If no permission error appears, ubridge is working correctly

# ========== KILL STUCK UBRIDGE PROCESSES ==========
# Kill any stuck ubridge processes (useful if nodes fail to start)
sudo pkill -f ubridge

# Force kill if normal kill doesn't work
sudo pkill -9 -f ubridge

# ========== VERIFY UBRIDGE GROUP EXISTS ==========
# Check if ubridge group exists
getent group ubridge

# ========== CREATE UBRIDGE GROUP IF MISSING ==========
# Create ubridge group if it doesn't exist
sudo groupadd ubridge

# ========== CHECK USER GROUPS ==========
# Verify user is in ubridge group
groups

# Output should include "ubridge" in the list

# ========== COMPLETE UBRIDGE SETUP ==========
# Full workflow to configure ubridge:

sudo chmod 755 /usr/bin/ubridge
sudo usermod -aG ubridge kasi
# Log out and log back in, then verify:
groups
ubridge -v

# ========== TROUBLESHOOT UBRIDGE ISSUES ==========
# If GNS3 nodes start and die immediately:

# 1. Check ubridge permissions
ls -l /usr/bin/ubridge

# 2. Verify user is in ubridge group
groups | grep ubridge

# 3. Test ubridge manually
ubridge -h

# 4. Kill stuck processes
sudo pkill -f ubridge

# 5. Check if ubridge is running
ps aux | grep ubridge

# ========== KVM KERNEL MODULE MANAGEMENT ==========
# Disable KVM (if GNS3 is configured for software emulation)
sudo modprobe -r kvm_intel
sudo modprobe -r kvm

# Enable KVM (for hardware-accelerated virtualization)
sudo modprobe -r kvm_intel
sudo modprobe -r kvm

# Check if KVM is loaded
lsmod | grep kvm

# ========== GNS3 TROUBLESHOOTING RELATED TO UBRIDGE ==========
# If nodes won't connect in GNS3:

# 1. Restart ubridge
sudo pkill -f ubridge

# 2. Restart GNS3 service
sudo systemctl restart gns3server.service

# 3. Check GNS3 logs
tail -f /var/log/gns3server.log

# 4. Verify group permissions
id -G kasi

# 5. Re-run ubridge test
ubridge -v
