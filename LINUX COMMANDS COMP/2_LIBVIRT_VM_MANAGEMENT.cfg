################################################################################
# LIBVIRT VM MANAGEMENT - Autostart, List, Control
# Purpose: Manage virtual machines (start, stop, enable autostart, list status)
# Used for: VM lifecycle management, autostart configuration
################################################################################

# ========== LIST & VIEW VMs ==========
# Shows all VMs on the system
sudo virsh list --all

# List only running VMs
sudo virsh list

# List only VMs set to autostart at boot
sudo virsh list --autostart

# Dump full XML configuration of a VM
sudo virsh dumpxml server1

# Read VM configuration file directly
sudo cat /etc/libvirt/qemu/server1.xml

# ========== ENABLE AUTOSTART FOR VMs ==========
# Enable autostart for a specific VM (runs automatically at boot)
sudo virsh autostart server1

# Enable autostart for ALL VMs at once
sudo virsh list --all --name | while read vm; do sudo virsh autostart "$vm"; done

# ========== DISABLE AUTOSTART ==========
# Disable autostart for a specific VM
sudo virsh autostart --disable server1

# ========== START & STOP VMs ==========
# Start a VM (graceful boot)
sudo virsh start server1

# Stop a VM gracefully (waits for OS to shutdown)
sudo virsh shutdown server1

# Force stop a VM immediately (like pulling power)
sudo virsh destroy server1

# Reboot a running VM
sudo virsh reboot server1

# ========== EDIT VM CONFIGURATION ==========
# Open VM XML configuration in editor
sudo virsh edit server1

# ========== DELETE VMs ==========
# Undefine a VM (removes it but keeps disk files)
sudo virsh undefine server1

# Undefine VM and remove associated disk files
sudo virsh undefine server1 --remove-all-storage

# ========== GET VM INFORMATION ==========
# Show basic VM information
sudo virsh dominfo server1

# Get VM state
sudo virsh domstate server1

# Get IP address of a VM
sudo virsh domifaddr server1

# Get VNC port for a VM
sudo virsh vncdisplay server1

# Show CPU and memory stats of running VM
sudo virsh domstats server1

# ========== CHECK VNC DISPLAYS FOR ALL VMs ==========
# Display VNC port mapping for all VMs
sudo virsh list --name | while read vm; do
  if [ -n "$vm" ]; then
    disp=$(sudo virsh vncdisplay "$vm")
    if [ "$disp" != "-" ]; then
      port=$((5900 + ${disp#:}))
      echo "$vm  →  VNC display $disp  →  port $port"
    else
      echo "$vm  →  no VNC (maybe SPICE)"
    fi
  fi
done

# ========== LIBVIRT SERVICE MANAGEMENT ==========
# Enable libvirt service to start at boot
sudo systemctl enable libvirtd

# Start libvirt service
sudo systemctl start libvirtd

# Restart libvirt service
sudo systemctl restart libvirtd

# Check libvirt service status
sudo systemctl status libvirtd

# Stop libvirt service
sudo systemctl stop libvirtd

# ========== LIBVIRT CONFIGURATION FOR CLEAN SHUTDOWN ==========
# Edit libvirt configuration for VM shutdown on host shutdown
sudo nano /etc/libvirt/qemu.conf

# Add or ensure these lines in qemu.conf:
# on_poweroff = "destroy"
# on_reboot = "restart"
# on_crash = "restart"

# Edit libvirtd configuration for shutdown timeout
sudo nano /etc/libvirt/libvirtd.conf

# Add or ensure this line (180 seconds timeout):
# shutdown_timeout = 180

# Reload libvirt after editing
sudo systemctl restart libvirtd

# ========== CHECK CONNECTIONS ==========
# Test libvirt connection
virsh connect qemu:///system

# Get system info
sudo virsh sysinfo

# ========== SNAPSHOT MANAGEMENT ==========
# Create a VM snapshot (for backup before changes)
sudo virsh snapshot-create-as server1 backup-before-update

# List all snapshots of a VM
sudo virsh snapshot-list server1

# Revert to a snapshot
sudo virsh snapshot-revert server1 backup-before-update

# Delete a snapshot
sudo virsh snapshot-delete server1 backup-before-update
