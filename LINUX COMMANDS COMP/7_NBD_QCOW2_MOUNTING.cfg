################################################################################
# NBD (Network Block Device) & QCOW2 IMAGE MOUNTING
# Purpose: Mount and modify QCOW2 disk images without VM running
# Used for: Injecting firmware, modifying configs, image troubleshooting
################################################################################

# ========== ENABLE NBD KERNEL MODULE ==========
# Load NBD kernel module with max partitions support
sudo modprobe nbd max_part=8

# ========== CONNECT QCOW2 IMAGE TO NBD DEVICE ==========
# Connect vEOS QCOW2 image to /dev/nbd0
sudo qemu-nbd --connect=/dev/nbd0 /home/kasi/GNS3/images/QEMU/vEOS-lab-4.33.5M.qcow2

# Connect to alternative NBD device if nbd0 is busy
sudo qemu-nbd --connect=/dev/nbd1 /home/kasi/GNS3/images/QEMU/vEOS-lab-4.33.5M.qcow2

# ========== CHECK PARTITIONS ON CONNECTED IMAGE ==========
# List partitions of connected NBD device
sudo fdisk -l /dev/nbd0

# Expected output should show:
# /dev/nbd0p1  →  small hidden partition (EFI/boot)
# /dev/nbd0p2  →  main Linux filesystem (~4G or larger)

# ========== CREATE MOUNT POINT ==========
# Create directory to mount the image
sudo mkdir -p /mnt/veos

# Alternative mount point
sudo mkdir -p /mnt/qcow2-image

# ========== MOUNT MAIN PARTITION ==========
# Mount the main partition (usually p2) to access filesystem
sudo mount /dev/nbd0p2 /mnt/veos

# Verify mount was successful
mount | grep nbd0

# ========== LIST MOUNTED CONTENT ==========
# List what's inside the mounted image
ls -la /mnt/veos

# ========== INJECT FIRMWARE INTO IMAGE ==========
# Copy SWI firmware file into the mounted image
sudo cp /home/kasi/GNS3/images/QEMU/vEOS-lab-4.33.5M.swi /mnt/veos/

# Verify file was copied
ls -lh /mnt/veos/vEOS-lab-4.33.5M.swi

# ========== INJECT VEOS DISK INTO QCOW2 ==========
# Complete workflow: connect, mount, copy firmware, unmount, disconnect

# Step 1: Load NBD module
sudo modprobe nbd max_part=8

# Step 2: Connect image
sudo qemu-nbd --connect=/dev/nbd0 /home/kasi/GNS3/images/QEMU/vEOS-lab-4.33.5M.qcow2

# Step 3: Check partitions
sudo fdisk -l /dev/nbd0

# Step 4: Mount main partition
sudo mkdir -p /mnt/veos
sudo mount /dev/nbd0p2 /mnt/veos

# Step 5: Copy SWI firmware
sudo cp /home/kasi/GNS3/images/QEMU/vEOS-lab-4.33.5M.swi /mnt/veos/

# Step 6: Sync filesystem (flush all writes)
sudo sync

# Step 7: Unmount (see next section)

# ========== SYNC DATA TO DISK ==========
# Force write any buffered data to disk before unmounting
sudo sync

# Verify all writes completed
sudo sync

# ========== UNMOUNT IMAGE PARTITION ==========
# Unmount the NBD partition
sudo umount /mnt/veos

# Verify unmount (should not appear in mount output)
mount | grep nbd0

# ========== DISCONNECT NBD DEVICE ==========
# Disconnect NBD device to release the image
sudo qemu-nbd --disconnect /dev/nbd0

# If connection is stuck, force disconnect with timeout
sudo qemu-nbd --disconnect /dev/nbd0 --force

# ========== MOUNT BOOT PARTITION (OPTIONAL) ==========
# To access boot/EFI partition instead of main filesystem
sudo mount /dev/nbd0p1 /mnt/veos

# This contains bootloader and firmware files

# ========== TROUBLESHOOTING NBD CONNECTIONS ==========
# List all connected NBD devices
lsblk | grep nbd

# Show detailed NBD information
sudo qemu-nbd -l

# Check if image is in use by another process
lsof /home/kasi/GNS3/images/QEMU/vEOS-lab-4.33.5M.qcow2

# Force kill processes holding image
sudo fuser -k /home/kasi/GNS3/images/QEMU/vEOS-lab-4.33.5M.qcow2

# ========== UNLOAD NBD MODULE ==========
# Unload NBD kernel module (if no longer needed)
sudo modprobe -r nbd

# ========== COMPLETE WORKFLOW EXAMPLE ==========
# Full sequence to inject firmware into Arista vEOS image

sudo modprobe nbd max_part=8
sudo qemu-nbd --connect=/dev/nbd0 /home/kasi/vEOS-lab-4.33.5M.qcow2
sudo fdisk -l /dev/nbd0
sudo mkdir -p /mnt/veos
sudo mount /dev/nbd0p2 /mnt/veos
sudo cp /home/kasi/vEOS-lab-4.33.5M.swi /mnt/veos/
sudo sync
sudo umount /mnt/veos
sudo qemu-nbd --disconnect /dev/nbd0
