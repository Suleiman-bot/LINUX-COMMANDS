################################################################################
# UEFI/OVMF VM CONFIGURATION
# Purpose: Configure VMs to boot with UEFI instead of BIOS
# Used for: Modern OS support, UEFI boot requirements, secure boot
################################################################################

# ========== INSTALL OVMF FIRMWARE ==========
# Install OVMF (Open Virtual Machine Firmware) for UEFI
sudo apt install ovmf -y

# Alternative package name on some systems
sudo apt install edk2 -y

# ========== CHECK OVMF FILES ==========
# List available OVMF files
ls /usr/share/OVMF/

# Show OVMF code and variable files
ls -l /usr/share/OVMF/OVMF_*

# Common files:
# /usr/share/OVMF/OVMF_CODE_4M.fd - UEFI code/ROM
# /usr/share/OVMF/OVMF_VARS_4M.fd - UEFI variables (writable)

# ========== CREATE NVRAM DIRECTORY ==========
# Create NVRAM directory for VM UEFI variables
sudo mkdir -p /var/lib/libvirt/qemu/nvram

# Set permissions
sudo chmod 755 /var/lib/libvirt/qemu/nvram

# ========== PREPARE VM FOR UEFI ==========
# Copy OVMF_VARS template for specific VM (example: kasi-PRTG)
sudo cp /usr/share/OVMF/OVMF_VARS_4M.fd /var/lib/libvirt/qemu/nvram/kasi-PRTG_VARS.fd

# Set ownership to libvirt-qemu
sudo chown libvirt-qemu:kvm /var/lib/libvirt/qemu/nvram/kasi-PRTG_VARS.fd

# Set permissions
sudo chmod 600 /var/lib/libvirt/qemu/nvram/kasi-PRTG_VARS.fd

# ========== EDIT VM XML TO USE UEFI ==========
# Open VM XML editor
sudo virsh edit kasi-PRTG

# Replace OS section with UEFI configuration:
# <os>
#   <type arch='x86_64' machine='pc-q35-7.2'>hvm</type>
#   <loader readonly='yes' type='pflash'>/usr/share/OVMF/OVMF_CODE_4M.fd</loader>
#   <nvram>/var/lib/libvirt/qemu/nvram/kasi-PRTG_VARS.fd</nvram>
#   <boot dev='hd'/>
# </os>

# ========== VERIFY UEFI CONFIGURATION ==========
# Check VM XML for UEFI settings
sudo virsh dumpxml kasi-PRTG | grep -A 10 "<os>"

# Should show loader and nvram lines

# ========== RESTART VM WITH UEFI ==========
# Shutdown VM first
sudo virsh shutdown kasi-PRTG

# Start VM (now with UEFI)
sudo virsh start kasi-PRTG

# Verify VM is running
sudo virsh list

# ========== CREATE NEW VM WITH UEFI FROM START ==========
# When using virt-install, add UEFI configuration
sudo virt-install \
  --name new-vm \
  --ram 8192 \
  --vcpus 4 \
  --disk path=/var/lib/libvirt/images/new-vm.qcow2,format=qcow2 \
  --import \
  --network bridge=virbr1 \
  --osinfo detect=on,require=off \
  --graphics vnc,port=59010,listen=0.0.0.0 \
  --uefi \
  --noautoconsole

# Alternative: specify UEFI directly
sudo virt-install \
  --name new-vm \
  --ram 8192 \
  --vcpus 4 \
  --disk path=/var/lib/libvirt/images/new-vm.qcow2,format=qcow2 \
  --import \
  --network bridge=virbr1 \
  --osinfo detect=on,require=off \
  --graphics vnc,port=59010,listen=0.0.0.0 \
  --boot loader=/usr/share/OVMF/OVMF_CODE_4M.fd,loader.readonly=yes,loader.type=pflash \
  --noautoconsole

# ========== UEFI FIRMWARE PACKAGES ==========
# Some distributions have UEFI support in different packages:

# Debian/Ubuntu
sudo apt install ovmf -y
sudo apt install qemu-efi-aarch64 -y  # For ARM64

# CentOS/AlmaLinux
sudo dnf install edk2-ovmf -y

# ========== TROUBLESHOOTING UEFI ==========
# VM won't boot with UEFI:
# 1. Verify OVMF files exist
ls /usr/share/OVMF/

# 2. Check VM XML is correct
sudo virsh dumpxml vm-name | grep -A 10 "<os>"

# 3. Check NVRAM file permissions
ls -l /var/lib/libvirt/qemu/nvram/

# 4. Ensure VM disk is properly formatted
qemu-img info /var/lib/libvirt/images/disk.qcow2

# 5. Check libvirt logs
sudo journalctl -u libvirtd -n 50

# ========== CONVERT BIOS VM TO UEFI ==========
# Process to change existing BIOS VM to UEFI:

# 1. Shutdown VM
sudo virsh shutdown vm-name

# 2. Create NVRAM file
sudo cp /usr/share/OVMF/OVMF_VARS_4M.fd /var/lib/libvirt/qemu/nvram/vm-name_VARS.fd
sudo chown libvirt-qemu:kvm /var/lib/libvirt/qemu/nvram/vm-name_VARS.fd

# 3. Edit XML
sudo virsh edit vm-name

# 4. Replace OS section with UEFI config
# 5. Start VM

# ========== UEFI BOOT OPTIONS ==========
# Enter UEFI boot menu (during VM startup)
# Press DEL or F2 during boot

# Boot order configuration in XML:
# <boot dev='hd'/>  - Boot from disk
# <boot dev='cdrom'/>  - Boot from CD
# <boot dev='network'/>  - Boot from network

# ========== SECURE BOOT (ADVANCED) ==========
# For Secure Boot support, additional configuration needed
# Usually requires OVMF with Secure Boot enabled build

# Check if Secure Boot is supported
strings /usr/share/OVMF/OVMF_CODE_4M.fd | grep -i "secure"
