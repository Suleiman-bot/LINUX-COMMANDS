################################################################################
# VM TROUBLESHOOTING & RECOVERY
# Purpose: Troubleshoot and recover VM configuration issues, fix common problems
# Used for: VM boot failures, configuration issues, disk problems
################################################################################

# ========== CHECK LIBVIRT XML CONFIGURATION ==========
# Dump VM XML configuration to view all settings
sudo virsh dumpxml server1

# Save VM configuration to file
sudo virsh dumpxml server1 > server1.xml

# Read VM XML directly from file
sudo cat /etc/libvirt/qemu/server1.xml

# Edit VM XML configuration
sudo virsh edit server1

# ========== VM DISK FILE LOCKING ISSUES ==========
# Check which process has disk image open
lsof /var/lib/libvirt/images/disk.qcow2

# Find all locked image files
lsof +D /var/lib/libvirt/images/

# Force kill process holding file
sudo fuser -k /var/lib/libvirt/images/disk.qcow2

# ========== REBASE BROKEN DISK IMAGES ==========
# Fix disk image backing file issues
qemu-img rebase -u /var/lib/libvirt/images/disk.qcow2

# Check if image has backing file
qemu-img info /var/lib/libvirt/images/disk.qcow2

# ========== VM DISK ERRORS ==========
# Check disk image for filesystem errors (VM must be OFF)
sudo qemu-img check /var/lib/libvirt/images/disk.qcow2

# Fix errors in disk image (may lose data)
sudo qemu-img check -r all /var/lib/libvirt/images/disk.qcow2

# Rebuild image from corrupted backing file
qemu-img convert -O qcow2 /var/lib/libvirt/images/corrupted.qcow2 /var/lib/libvirt/images/recovered.qcow2

# ========== VM WON'T START ==========
# Check VM state
sudo virsh domstate server1

# Check for error messages
sudo virsh start server1 2>&1

# Check libvirt daemon logs
sudo journalctl -u libvirtd -n 100

# Check VM console output
sudo virsh console server1

# ========== VNC CONNECTION ISSUES ==========
# Get VNC display for VM
sudo virsh vncdisplay server1

# Get VNC port from VM XML
sudo virsh dumpxml server1 | grep vnc

# Change VNC port (edit XML and restart VM)
sudo virsh edit server1
# Modify: <graphics type='vnc' port='59001' ...

# Connect via VNC at specific port
# Use VNC client: <host-ip>:59001 (port 5900 + 59001 = port 64901)

# ========== NETWORK CONNECTIVITY ISSUES ==========
# Check VM network interfaces
sudo virsh domifaddr server1

# Check VM network config
sudo virsh dumpxml server1 | grep -A 10 network

# Restart network interface in VM
sudo virsh domiflist server1

# Get IP address if DHCP is configured
sudo virsh domifaddr server1 --interface vnet0

# ========== VM CRASHES OR HANGS ==========
# Force stop stuck VM
sudo virsh destroy server1

# Kill VNC processes if stuck
sudo pkill -f 'qemu.*server1'

# Check for kernel panics in logs
sudo journalctl -p err

# ========== VM RUNS OUT OF DISK SPACE ==========
# Check current VM disk usage
sudo virsh vol-info --pool vmdata disk.qcow2

# List volumes in pool
sudo virsh vol-list vmdata

# Extend logical volume
sudo lvextend -l +100%FREE /dev/ubuntu-vg/ubuntu-lv

# Resize filesystem
sudo resize2fs /dev/ubuntu-vg/ubuntu-lv

# ========== VM MEMORY ISSUES ==========
# Check VM current memory
sudo virsh dominfo server1

# Set temporary maximum memory
sudo virsh setmem server1 8192 --config

# Check system memory
free -h

# Monitor VM memory usage
sudo virsh domstats server1 --memory

# ========== VM CPU ISSUES ==========
# Check VM CPU count
sudo virsh dominfo server1

# Change vCPU count
sudo virsh setvcpus server1 4 --config

# ========== REMOVE AND RECREATE VM ==========
# List all VMs
sudo virsh list --all

# Stop VM before undefining
sudo virsh shutdown server1

# Undefine VM (removes config, keeps disk)
sudo virsh undefine server1

# Recreate from disk
sudo virt-install \
  --name server1 \
  --ram 8192 \
  --vcpus 2 \
  --disk path=/var/lib/libvirt/images/disk.qcow2,format=qcow2 \
  --import \
  --network bridge=virbr1 \
  --osinfo detect=on,require=off \
  --noautoconsole

# ========== RECOVER DELETED VM CONFIG ==========
# Check if backup config exists
sudo find /etc/libvirt -name "*.xml"

# Check if VM disk file still exists
ls -lh /var/lib/libvirt/images/

# Define VM from existing disk (recreate config)
sudo virsh create /etc/libvirt/qemu/server1.xml

# ========== VIRSH TROUBLESHOOTING ==========
# Test libvirt connection
virsh connect qemu:///system

# Check hypervisor capabilities
sudo virsh capabilities

# Show system info
sudo virsh sysinfo

# List networks
sudo virsh net-list

# Check storage pool status
sudo virsh pool-list --all

# ========== MIGRATION BETWEEN HOSTS ==========
# Migrate running VM to another host
sudo virsh migrate --live server1 qemu+ssh://user@host/system

# Check migration status
sudo virsh migrate-status server1

# ========== VM SNAPSHOTS FOR RECOVERY ==========
# Create snapshot before making changes
sudo virsh snapshot-create-as server1 backup-$(date +%Y%m%d-%H%M%S)

# List snapshots
sudo virsh snapshot-list server1

# Revert to snapshot
sudo virsh snapshot-revert server1 snapshot-name

# Delete old snapshot
sudo virsh snapshot-delete server1 snapshot-name
