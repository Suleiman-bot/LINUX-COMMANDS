################################################################################
# KVM/QEMU CONTROL & KERNEL MODULE MANAGEMENT
# Purpose: Enable/disable KVM acceleration, manage kernel modules
# Used for: Virtualization performance tuning, system resource management
################################################################################

# ========== CHECK IF KVM IS AVAILABLE ==========
# Check if KVM CPU extensions are supported
grep -E 'vmx|svm' /proc/cpuinfo

# If output shows "vmx" = Intel processor with KVM support
# If output shows "svm" = AMD processor with KVM support

# ========== LIST LOADED KERNEL MODULES ==========
# Show all loaded KVM-related kernel modules
lsmod | grep kvm

# Show all virtualization modules
lsmod | grep -E 'kvm|qemu'

# ========== LOAD KVM KERNEL MODULES ==========
# Load Intel KVM module
sudo modprobe kvm_intel

# Load AMD KVM module
sudo modprobe kvm_amd

# Load base KVM module
sudo modprobe kvm

# ========== UNLOAD KVM KERNEL MODULES ==========
# WARNING: Only unload when no VMs are running!

# Disable Intel KVM
sudo modprobe -r kvm_intel

# Disable AMD KVM
sudo modprobe -r kvm_amd

# Disable base KVM
sudo modprobe -r kvm

# ========== KVM PARAMETERS ==========
# Check KVM Intel parameters
cat /sys/module/kvm_intel/parameters/*

# Check KVM AMD parameters
cat /sys/module/kvm_amd/parameters/*

# ========== ENABLE KVM NESTING (OPTIONAL) ==========
# Allow VMs to run VMs inside them (advanced use case)
# For Intel:
sudo modprobe -r kvm_intel
sudo modprobe kvm_intel nested=1

# For AMD:
sudo modprobe -r kvm_amd
sudo modprobe kvm_amd nested=1

# Verify nesting is enabled
cat /sys/module/kvm_intel/parameters/nested

# ========== MAKE KERNEL PARAMETERS PERMANENT ==========
# Create or edit modprobe configuration
sudo nano /etc/modprobe.d/kvm.conf

# Add these lines for Intel:
# options kvm_intel nested=1

# Add these lines for AMD:
# options kvm_amd nested=1

# ========== LOAD UBRIDGE MODULE ==========
# Load NBD module (for mounting QCOW2 images)
sudo modprobe nbd max_part=8

# ========== CHECK VIRTUALIZATION STATUS ==========
# Check if virtualization is enabled in BIOS
kvm-ok

# Verify virtualization extensions are available
grep -E 'vmx|svm' /proc/cpuinfo | head -1

# ========== LIST LOADED MODULES ==========
# Show all currently loaded kernel modules
lsmod

# Show kernel module dependencies
modinfo kvm_intel

# ========== RESTART LIBVIRT AFTER MODULE CHANGES ==========
# Restart libvirt daemon to apply KVM changes
sudo systemctl restart libvirtd

# Check libvirt status
sudo systemctl status libvirtd

# ========== COMMON KVM TROUBLESHOOTING ==========
# If VMs won't start, check these:

# 1. Verify KVM is loaded
lsmod | grep kvm

# 2. Check if virtualization is enabled
kvm-ok

# 3. Restart libvirt
sudo systemctl restart libvirtd

# 4. Check libvirt logs
sudo journalctl -u libvirtd -n 50

# ========== QEMU INFORMATION ==========
# Show QEMU system version
qemu-system-x86_64 --version

# List supported CPU models
qemu-system-x86_64 -cpu help | head -20

# List available machine types
qemu-system-x86_64 -M help | head -20

# ========== PERFORMANCE TUNING ==========
# Enable KVM huge pages for better performance
# Edit: sudo nano /etc/libvirt/qemu.conf
# Add: hugetlbfs_mount = "/dev/hugepages"

# Check current hugepages allocation
grep HugePages /proc/meminfo

# Allocate hugepages (example: 1024 x 2MB = 2GB)
sudo sysctl vm.nr_hugepages=1024

# Make hugepages persistent
sudo nano /etc/sysctl.conf
# Add: vm.nr_hugepages=1024
sudo sysctl -p
